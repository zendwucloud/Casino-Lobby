<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Casino Lobby - Ultimate</title>
    <style>
        /* --- å…¨å±€è¨­å®š --- */
        :root {
            --text-gold: #f4d06f;
            --text-white: #ffffff;
            --panel-bg: rgba(25, 28, 40, 0.65); 
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        /* æ ¸å¿ƒåŸºç¤è¨­å®š */
        html, body {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            background-color: #000;
            overflow: hidden;
            position: fixed; 
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #333333 0%, #000000 85%);
            background-image: url('bg.jpg'); 
            background-size: cover;       
            background-position: center;  
            background-repeat: no-repeat; 
            
            overscroll-behavior: none; 
            touch-action: none;        
            user-select: none;         
            -webkit-user-select: none; 
        }

        img { -webkit-user-drag: none; user-drag: none; }

        /* æ‡‰ç”¨ç¨‹å¼å®¹å™¨ï¼šè‡ªå‹•é©æ‡‰æ¯”ä¾‹ */
        .app-container {
            position: relative;
            height: 100%; 
            aspect-ratio: 9/16;
            max-width: 100vw;
            display: flex; flex-direction: column;
            background-color: #121212; 
            background-image: url('bg.png'); 
            background-size: 100% 100%; background-repeat: no-repeat;
            box-shadow: 0 0 80px rgba(0,0,0,0.9); 
            z-index: 1; overflow: hidden;
        }

        /* --- â˜… æ™ºèƒ½è½‰å‘é–å®šæç¤º (åªé‡å°æ‰‹æ©Ÿ) --- */
        #orientation-lock {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100000;
            flex-direction: column; justify-content: center; align-items: center;
            color: #f4d06f; text-align: center;
        }
        #orientation-lock span {
            font-size: 5vh; margin-bottom: 20px; display: block;
            animation: rotatePhone 2s infinite ease-in-out;
        }
        #orientation-lock p { font-size: 2.5vh; font-weight: bold; font-family: sans-serif; }

        @keyframes rotatePhone {
            0% { transform: rotate(-90deg); }
            50% { transform: rotate(0deg); }
            100% { transform: rotate(-90deg); }
        }

        /* â˜… [é—œéµ CSS] åªæœ‰åœ¨ã€Œæ©«å‘ã€+ã€Œè§¸æ§è£ç½®(æ‰‹æ©Ÿ)ã€æ™‚æ‰è§¸ç™¼é–å®š */
        @media screen and (orientation: landscape) and (hover: none) and (pointer: coarse) {
            .app-container { display: none !important; }
            #orientation-lock { display: flex; }
            body { background: #000 !important; }
        }


        #lobby-bg-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none; mix-blend-mode: screen; }

        .gradient-border-box::after {
            content: ""; position: absolute; inset: 0; border-radius: inherit; padding: 1.5px; 
            background: linear-gradient(90deg, rgba(170, 135, 65, 0) 0%, #aa8741 25%, #cbbd83 50%, #aa8741 75%, rgba(170, 135, 65, 0) 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor; mask-composite: exclude;
            pointer-events: none; z-index: 10; 
        }

        /* --- UI Bars --- */
        .top-bar {
            position: absolute; top: 0; left: 0; height: 10%; width: 100%; padding: 0 2%;
            display: flex; align-items: center; justify-content: space-between; z-index: 200;
            background: rgba(20, 22, 35, 0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 0 0 4vh 4vh;
            box-shadow: 0 5px 25px rgba(0,0,0,0.5), inset 0 0 25px rgba(255, 220, 150, 0.15);
        }
        .top-bar.gradient-border-box::after { top: -4px; height: calc(100% + 2px); }

        .user-section { display: flex; align-items: center; gap: 6px; width: auto; flex-shrink: 0; margin-right: 5px; }
        .avatar-img { height: 5.5vh; width: 5.5vh; border-radius: 50%; object-fit: cover; border: 2px solid #333; transition: border-color 0.3s; }
        .vip-text { color: var(--text-gold); font-weight: 800; font-size: 1.8vh; letter-spacing: 0.5px; transition: color 0.3s; }
        
        .coin-bar { 
            flex: 1; height: 55%; 
            display: flex; align-items: center; justify-content: space-between; 
            background: rgba(0, 0, 0, 0.4); 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 50px; 
            box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.8), 0 0 10px rgba(255, 255, 255, 0.15);  
            backdrop-filter: blur(5px);
            padding: 0 8px 0 6px; 
            min-width: 0; 
        }

        .gold-icon { height: 63%; width: auto; flex-shrink: 0; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.5)); }
        
        .center-group { 
            flex: 1; display: flex; align-items: center; 
            justify-content: flex-end; 
            min-width: 0; padding-right: 0; overflow: hidden; 
        }
        
        .coin-number { 
            color: var(--text-white); 
            font-weight: 700; 
            font-size: 3.5vh; 
            margin-right: 8px; margin-top: -4px; 
            letter-spacing: 0.5px; white-space: nowrap; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); 
            overflow: hidden; text-overflow: ellipsis; line-height: 1.1; 
        }
        
        .coins-text-img { 
            height: 1.8vh; 
            width: auto; margin-top: 3px; opacity: 0.8; flex-shrink: 0; 
        } 
        
        .clickable-btn { transition: transform 0.1s ease; }
        .clickable-btn:active { transform: scale(0.85); filter: brightness(1.2); }
        .plus-btn { display: none; }
        .menu-btn { height: 28%; width: auto; cursor: pointer; margin-left: 8px; flex-shrink: 0;}

        /* --- Ghost Ticker --- */
        #ghost-ticker {
            position: absolute; top: 11%; left: 50%; transform: translateX(-50%);
            width: 90%; height: 3.5vh;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.15);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; pointer-events: none; z-index: 190;
            opacity: 0; transition: opacity 0.5s ease;
        }
        #ghost-ticker.active { opacity: 1; }
        .ticker-content {
            white-space: nowrap; color: #ffffff; font-weight: normal; font-size: 2.0vh;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.9);
        }
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-150%); }
        }

        /* --- Option Dropdown Menu --- */
        #option-dropdown {
            position: absolute; top: 75%; right: 10px; width: 180px;
            background: rgba(30, 33, 48, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px; padding: 5px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 500;
            transform-origin: top right; transform: scale(0.8); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #option-dropdown.active { transform: scale(1); opacity: 1; pointer-events: all; }
        .opt-item { padding: 12px 15px; color: #ccc; font-size: 1.5vh; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; }
        .opt-item:active { background: rgba(255, 215, 0, 0.15); color: #fff; }
        .opt-icon { width: 20px; text-align: center; }
        .opt-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

        /* --- åº•éƒ¨å°èˆª (æ·±è‰²ç‰ˆ) --- */
        .bottom-nav {
            position: absolute; bottom: 2.5vh; left: 3%; width: 94%; height: 11.7%;
            display: flex; justify-content: space-around; align-items: center; z-index: 200;
            background: rgba(20, 22, 35, 0.65); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 4vh; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5), inset 0 0 25px rgba(255, 220, 150, 0.15);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0; cursor: pointer; width: 20%; height: 100%; transition: transform 0.1s; }
        .nav-item:active { transform: scale(0.9); }
        .nav-icon { height: 75%; width: auto; object-fit: contain; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3)); transform: scale(0.85) translateY(2px); transition: transform 0.2s; }
        
        .nav-label { 
            font-size: 1.6vh; 
            font-weight: 700; 
            color: #aaa; 
            letter-spacing: 0.5px; 
            margin-top: -8px; 
            z-index: 2; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.8); 
        }
        
        .nav-item.active .nav-icon { animation: breathe 2.5s ease-in-out infinite; }
        .nav-item.active .nav-label { 
            color: #fff; 
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8); 
        }
        @keyframes breathe {
            0% { transform: scale(1.1) translateY(2px); filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4)); }
            50% { transform: scale(1.15) translateY(2px); filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.8)); }
            100% { transform: scale(1.1) translateY(2px); filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.4)); }
        }

        /* --- ä¸»éŠæˆ²åˆ—è¡¨ --- */
        .main-scroll-area {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding-top: calc(10% + 50px); padding-bottom: 18%; 
            display: flex; flex-direction: column; gap: 10px; 
            position: relative; z-index: 5; 
            transition: opacity 0.3s ease, transform 0.3s ease;
            touch-action: pan-y; 
        }
        .main-scroll-area::-webkit-scrollbar { display: none; }
        .main-scroll-area.hidden .game-card:nth-child(odd) { transform: translateX(-120%); opacity: 0; }
        .main-scroll-area.hidden .game-card:nth-child(even) { transform: translateX(120%); opacity: 0; }
        .game-card { width: 80.6%; aspect-ratio: 2/1; margin: 0 auto; position: relative; border-radius: 26px; overflow: hidden; box-shadow: none !important; border: none !important; background: transparent; flex-shrink: 0; opacity: 0; animation: slideIn 0.5s ease-out forwards; cursor: pointer; transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.3s ease; }
        .game-card::after { content: ""; position: absolute; top: 0; left: 0; width: 200%; height: 100%; background: linear-gradient(120deg, rgba(255, 255, 255, 0) 30%, rgba(255, 255, 255, 0.4) 50%, rgba(255, 215, 0, 0.2) 55%, rgba(255, 255, 255, 0) 70%); transform: translateX(-150%) skewX(-25deg); pointer-events: none; mix-blend-mode: overlay; animation: shimmer 5s infinite; }
        .game-card:nth-child(odd)::after { animation-delay: 0s; } .game-card:nth-child(even)::after { animation-delay: 2.5s; }
        .game-img { width: 100%; height: 100%; object-fit: cover; display: block; }
        @keyframes launchSequence { 0% { transform: scale(1); filter: brightness(1); opacity: 1; } 40% { transform: scale(0.95); filter: brightness(1.3) contrast(1.1) drop-shadow(0 0 30px rgba(255, 215, 0, 0.8)); opacity: 1; } 100% { transform: scale(1.15); filter: brightness(1.5) drop-shadow(0 0 60px rgba(255, 215, 0, 0)); opacity: 0; } }
        .game-card.launching { opacity: 1 !important; animation: launchSequence 0.5s ease-in-out forwards; z-index: 999; pointer-events: none; }
        .game-card.launching::after { opacity: 0; transition: opacity 0.1s; }
        @keyframes slideIn { 0% { opacity: 0; transform: translateY(80px); } 70% { opacity: 1; transform: translateY(-5px); } 100% { opacity: 1; transform: translateY(0); } }
        @keyframes shimmer { 0% { transform: translateX(-150%) skewX(-25deg); } 60% { transform: translateX(150%) skewX(-25deg); } 100% { transform: translateX(150%) skewX(-25deg); } }
        .game-card:nth-child(1) { animation-delay: 0.1s; } .game-card:nth-child(2) { animation-delay: 0.2s; } .game-card:nth-child(3) { animation-delay: 0.3s; } .game-card:nth-child(4) { animation-delay: 0.4s; } .game-card:nth-child(5) { animation-delay: 0.5s; }


        /* ========================================= */
        /* --- Crystal Panel Styles --- */
        /* ========================================= */
        .dashboard-panel {
            position: absolute; top: 48%; left: 50%; height: 72%; width: 90%;
            background: var(--panel-bg);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: 20px; z-index: 150; 
            display: flex; flex-direction: column; opacity: 0; pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transform: translate(-50%, -50%) scale(0.8);
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.9), 
                inset 0 0 30px rgba(255, 255, 255, 0.05),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .dashboard-panel.active { opacity: 1; pointer-events: all; transform: translate(-50%, -50%) scale(1); }

        .panel-header { height: 10%; display: flex; justify-content: space-around; align-items: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 0 10px; flex-shrink: 0; }
        .tab-item { color: #888; font-size: 1.6vh; font-weight: 700; cursor: pointer; position: relative; padding: 5px 0; transition: color 0.3s; }
        .tab-item.active { color: var(--text-gold); text-shadow: 0 0 10px rgba(244, 208, 111, 0.5); }
        .tab-item.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--text-gold); box-shadow: 0 0 5px var(--text-gold); }
        .panel-footer { height: 14%; display: flex; justify-content: center; align-items: center; padding: 0 20px; border-top: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
        .close-gold-btn { background: linear-gradient(180deg, #ffeebb 0%, #aa8741 50%, #75551d 100%); border: 1px solid #ffd700; border-radius: 20px; padding: 8px 45px; color: #422100; font-weight: 800; font-size: 1.8vh; letter-spacing: 1px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); cursor: pointer; transition: transform 0.1s; }
        .close-gold-btn:active { transform: scale(0.95); filter: brightness(1.1); }
        
        .panel-content { flex: 1; padding: 15px 10px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #aa8741 rgba(255, 255, 255, 0.1); touch-action: pan-y; }
        .panel-content::-webkit-scrollbar { width: 5px; } .panel-content::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; } .panel-content::-webkit-scrollbar-thumb { background: linear-gradient(180deg, #aa8741, #cbbd83); border-radius: 10px; }

        /* Slots Grid */
        .slots-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 100%; }
        .slot-icon { width: 100%; aspect-ratio: 2/1; border-radius: 8px; overflow: hidden; background: #000; position: relative; border: 1px solid rgba(255, 255, 255, 0.15); transition: transform 0.1s; }
        .slot-icon:active { transform: scale(0.9); border-color: var(--text-gold); }
        .slot-thumb { width: 100%; height: 100%; object-fit: cover; }

        /* Rewards Styles */
        .rewards-tabs { height: 12%; display: flex; align-items: center; justify-content: center; gap: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 0 10px; }
        .r-tab-btn { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #aaa; padding: 6px 16px; border-radius: 20px; font-size: 1.5vh; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .r-tab-btn.active { background: linear-gradient(180deg, #ffeebb 0%, #aa8741 100%); border-color: #ffd700; color: #422100; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        
        .rewards-content { flex: 1; padding: 15px; overflow-y: auto; position: relative; touch-action: pan-y; }
        .r-view { display: none; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .r-view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Daily/Mail/Gift Styles */
        .daily-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; height: 100%; align-content: start; }
        .day-box { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; aspect-ratio: 1/1.1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; transition: all 0.3s; }
        .day-box.day-7 { grid-column: 1 / -1; aspect-ratio: 3/1; background: linear-gradient(45deg, rgba(255,215,0,0.1), rgba(255,0,0,0.1)); border: 1px solid rgba(255,215,0,0.3); }
        .day-num { font-size: 1.2vh; color: #888; margin-bottom: 5px; }
        .day-coin-img { width: 50%; height: auto; margin-bottom: 5px; filter: drop-shadow(0 0 5px rgba(255,215,0,0.5)); }
        .day-val { font-size: 1.6vh; color: #fff; font-weight: 800; }
        
        .day-box.claimed { opacity: 0.5; }
        .day-box.claimed .day-coin-img, .day-box.claimed .day-val, .day-box.claimed .day-num { filter: grayscale(1); }
        .day-box.claimed::after { content: "âœ”"; position: absolute; font-size: 3vh; color: #00ff00; text-shadow: 0 0 5px #000; font-weight: 900; filter: none; }
        .day-box.active { 
            border-color: #ffd700; 
            background: rgba(255, 215, 0, 0.1); 
            cursor: pointer; 
            animation: pulseBox 1.5s infinite; 
            opacity: 1; 
            filter: grayscale(0);
            pointer-events: auto !important; /* â˜… å¼·åˆ¶é–‹å•Ÿé»æ“Š */
            z-index: 10; /* â˜… ç¢ºä¿æµ®åœ¨æœ€ä¸Šå±¤ */
        }
        .day-box.active .day-val { color: #ffd700; text-shadow: 0 0 5px orange; }
        .day-box.normal { opacity: 0.4; filter: grayscale(0.8); pointer-events: none; }

        @keyframes pulseBox { 0% { transform: scale(1); } 50% { transform: scale(1.02); box-shadow: 0 0 15px rgba(255,215,0,0.3); } 100% { transform: scale(1); } }
        
        /* ä¿¡ç®±æ¨£å¼å„ªåŒ– */
        .mail-list { display: flex; flex-direction: column; gap: 8px; }
        .mail-item { 
            background: rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; 
            display: flex; align-items: center; gap: 10px; cursor: pointer; 
            transition: all 0.2s; border-left: 3px solid transparent; 
            justify-content: space-between; 
        }
        .mail-item:active { background: rgba(255,255,255,0.1); }
        
        /* æœªè®€ç‹€æ…‹ */
        .mail-item.unread { border-left: 3px solid #ff4500; background: rgba(255, 69, 0, 0.1); }
        .mail-item.unread .mail-title { color: #fff; text-shadow: 0 0 5px rgba(255,69,0,0.5); }
        .mail-item.unread .mail-icon { filter: drop-shadow(0 0 5px orange); }

        /* å·²è®€ç‹€æ…‹ (ç°è‰²) */
        .mail-item.read { 
            background: rgba(0,0,0,0.2); 
            border-left: 3px solid #666; 
            opacity: 0.7; 
            filter: grayscale(0.8); 
        }
        .mail-item.read .mail-title { color: #aaa; }

        .mail-content-wrapper { display: flex; align-items: center; gap: 10px; flex: 1; } 
        .mail-icon { font-size: 2.5vh; }
        .mail-info { flex: 1; }
        .mail-title { color: #fff; font-size: 1.6vh; font-weight: bold; margin-bottom: 2px; }
        .mail-date { color: #666; font-size: 1.2vh; }
        .mail-status { font-size: 1.2vh; color: #aaa; }

        /* åˆªé™¤æŒ‰éˆ• */
        .mail-delete-btn {
            padding: 5px 10px; background: rgba(255, 0, 0, 0.2); border-radius: 5px; 
            color: #ff4444; font-size: 1.4vh; border: 1px solid rgba(255,0,0,0.3);
            cursor: pointer; z-index: 2;
        }
        .mail-delete-btn:active { background: rgba(255,0,0,0.5); color: #fff; }

        /* å¯«ä¿¡å€å¡Šæ¨£å¼ */
        .compose-btn-container { text-align: right; margin-bottom: 10px; }
        .compose-btn { 
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%); 
            border: 1px solid #6a82fb; padding: 6px 12px; border-radius: 15px; 
            color: white; font-size: 1.4vh; cursor: pointer; 
        }
        #view-compose { display: none; height: 100%; flex-direction: column; }
        #view-compose.active { display: flex; }

        .gift-container { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; text-align: center; gap: 20px; }
        .gift-input-group { width: 100%; }
        .gift-label { color: #aaa; font-size: 1.4vh; margin-bottom: 5px; display: block; text-align: left; padding-left: 10px; }
        .gift-input { width: 100%; padding: 12px; border-radius: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 1.6vh; outline: none; }
        .gift-input:focus { border-color: #ffd700; }
        .gift-textarea { height: 100px; resize: none; }
        .send-btn { width: 100%; padding: 12px; border-radius: 10px; background: linear-gradient(90deg, #ff4500, #ff8c00); color: white; font-weight: bold; border: none; font-size: 1.8vh; cursor: pointer; box-shadow: 0 4px 10px rgba(255, 69, 0, 0.4); }
        .send-btn:active { transform: scale(0.95); filter: brightness(0.8); }

        /* --- Profile Styles --- */
        .profile-header { padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px; background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0) 100%); border-radius: 20px 20px 0 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .p-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid #ffd700; box-shadow: 0 0 15px rgba(255, 215, 0, 0.3); transition: border-color 0.3s; }
        .p-info { text-align: center; }
        .p-name { color: #fff; font-size: 2.2vh; font-weight: 800; }
        .p-id { color: #888; font-size: 1.4vh; margin-top: 2px; }
        .vip-container { width: 100%; margin-top: 10px; }
        .vip-labels { display: flex; justify-content: space-between; font-size: 1.2vh; color: #ffd700; font-weight: bold; margin-bottom: 4px; }
        .vip-track { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; }
        .vip-fill { width: 35%; height: 100%; background: linear-gradient(90deg, #ffd700, #ff8c00); box-shadow: 0 0 10px #ffd700; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 20px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .stat-label { color: #aaa; font-size: 1.4vh; margin-bottom: 5px; }
        .stat-val { color: #fff; font-size: 2vh; font-weight: bold; }
        .settings-list { padding: 0 20px; display: flex; flex-direction: column; gap: 10px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 10px; }
        .setting-label { color: #fff; font-size: 1.6vh; }
        /* èª¿æ•´æŒ‰éˆ•ç‚ºåˆ‡æ›å½¢å¼ */
        .toggle-switch-small { position: relative; display: inline-block; width: 40px; height: 20px; }
        .toggle-switch-small input { opacity: 0; width: 0; height: 0; }
        .slider-small { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-small:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-small { background-color: #ffd700; }
        input:checked + .slider-small:before { transform: translateX(20px); }

        .logout-btn { margin: 20px; padding: 12px; border-radius: 10px; background: rgba(255, 69, 0, 0.2); border: 1px solid rgba(255, 69, 0, 0.5); color: #ff4500; font-weight: bold; text-align: center; cursor: pointer; transition: all 0.2s; }
        .logout-btn:active { background: rgba(255, 69, 0, 0.4); transform: scale(0.98); }

        /* --- Rankings Panel Styles --- */
        .rank-list { padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .rank-item { display: flex; align-items: center; background: rgba(255, 255, 255, 0.05); padding: 12px 15px; border-radius: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }
        .rank-num { width: 30px; font-size: 2vh; font-weight: 900; color: #888; text-align: center; }
        .rank-item:nth-child(1) .rank-num { color: #ffd700; text-shadow: 0 0 10px #ffd700; font-size: 2.5vh; }
        .rank-item:nth-child(2) .rank-num { color: #c0c0c0; text-shadow: 0 0 5px #c0c0c0; }
        .rank-item:nth-child(3) .rank-num { color: #cd7f32; text-shadow: 0 0 5px #cd7f32; }
        .rank-avatar { width: 35px; height: 35px; border-radius: 50%; margin: 0 15px; border: 1px solid #555; object-fit: cover; }
        .rank-info { flex: 1; }
        .rank-name { color: #fff; font-weight: bold; font-size: 1.6vh; }
        .rank-vip { font-size: 1.2vh; background: #333; color: #ffd700; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; }
        .rank-val { color: #00ff00; font-weight: bold; font-size: 1.6vh; }

        /* --- Crystal Wallet Modal --- */
        #wallet-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #wallet-modal.active { opacity: 1; pointer-events: all; }
        .wallet-box { 
            width: 85%; 
            background: linear-gradient(145deg, rgba(42, 45, 62, 0.8), rgba(26, 28, 41, 0.9)); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 20px; padding: 20px; position: relative; 
            border: 1px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 40px rgba(0,0,0,0.8), inset 0 0 20px rgba(255,255,255,0.05);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        #wallet-modal.active .wallet-box { transform: scale(1); }
        .w-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        .w-title { color: #ffd700; font-size: 2.2vh; font-weight: 800; letter-spacing: 1px; }
        .w-balance { color: #fff; font-size: 1.6vh; margin-top: 5px; opacity: 0.8; }
        .w-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
        .w-option { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,215,0,0.1); border-radius: 10px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .w-option.active { border-color: #ffd700; background: rgba(255,215,0,0.1); }
        .w-option:active { transform: scale(0.95); }
        .w-coins { color: #ffd700; font-size: 2vh; font-weight: bold; display: block; margin-bottom: 5px; }
        .w-price { color: #fff; font-size: 1.4vh; background: #ff4500; padding: 2px 8px; border-radius: 4px; display: inline-block; }
        .w-actions { display: flex; gap: 10px; }
        .w-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 1.6vh; }
        .w-btn.cancel { background: rgba(255,255,255,0.1); color: #aaa; }
        .w-btn.confirm { background: linear-gradient(90deg, #ffd700, #ff8c00); color: #422100; box-shadow: 0 0 10px rgba(255,215,0,0.4); }
        .w-btn:active { transform: scale(0.95); }

        /* --- Overlay & Game Container --- */
        #transition-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; }
        #transition-overlay.active { opacity: 1; pointer-events: all; }
        
        #game-container { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; z-index: 20000; background: #000; display: none; }
        #game-frame { width: 100%; height: 100%; border: none; display: block; }
        
        #close-game-btn { position: absolute; top: 40px; left: 20px; z-index: 20001; display: none !important; }
        
        /* --- [Visual Upgraded] Auth Modal Styles --- */
        #auth-modal { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            z-index: 30000; 
            display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.5s ease-in-out; 
        }
        #auth-modal.active { opacity: 1; pointer-events: all; }

        .auth-actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .btn-full-width {
            width: 100%;
            grid-column: 1 / -1; 
        }

        /* --- Option Dropdown Menu --- */
        #option-dropdown {
            position: absolute; top: 75%; right: 10px; width: 180px;
            background: rgba(30, 33, 48, 0.95);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px; padding: 5px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 500;
            transform-origin: top right; transform: scale(0.8); opacity: 0; pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #option-dropdown.active { transform: scale(1); opacity: 1; pointer-events: all; }
        .opt-item { padding: 12px 15px; color: #ccc; font-size: 1.5vh; display: flex; align-items: center; gap: 10px; cursor: pointer; transition: background 0.2s; }
        .opt-item:active { background: rgba(255, 215, 0, 0.15); color: #fff; }
        .opt-icon { width: 20px; text-align: center; }
        .opt-divider { height: 1px; background: rgba(255,255,255,0.1); margin: 4px 0; }

    </style>
</head>
<body>

    <audio id="bgm_lobby" src="bgm_lobby.mp3" loop preload="auto" autoplay></audio>
    <audio id="sfx_click" src="sfx_click.mp3" preload="auto"></audio>
    <audio id="sfx_take" src="take.mp3" preload="auto"></audio>
    <audio id="sfx_money" src="money.mp3" preload="auto"></audio>

    <div id="orientation-lock">
        <span>ğŸ“±</span>
        <p>è«‹å°‡æ‰‹æ©Ÿè½‰ç‚ºç›´å‘<br>ä»¥ç²å¾—æœ€ä½³é«”é©—</p>
    </div>

    <div class="app-container">
        
        <canvas id="lobby-bg-canvas"></canvas>

        <header class="top-bar gradient-border-box">
            <div class="user-section">
                <img src="player.png" class="avatar-img" alt="User">
                <span class="vip-text">VIP.1</span>
            </div>
            <div class="coin-bar">
                <img src="gold.png" class="gold-icon" alt="G">
                <div class="center-group">
                    <span class="coin-number">0.00</span>
                    <img src="coins.png" class="coins-text-img" alt="COINS">
                </div>
                <img src="+.png" class="plus-btn clickable-btn" alt="+">
            </div>
            <img src="option.png" class="menu-btn clickable-btn" alt="Menu">
            
            <div id="option-dropdown">
                <div class="opt-item" onclick="optAction('support')">
                    <span class="opt-icon">ğŸ§</span> è¯çµ¡å®¢æœ
                </div>
                <div class="opt-item" onclick="optAction('history')">
                    <span class="opt-icon">ğŸ“œ</span> æŠ•æ³¨ç´€éŒ„
                </div>
                <div class="opt-item" onclick="optAction('lang')">
                    <span class="opt-icon">ğŸŒ</span> èªè¨€: ç¹é«”ä¸­æ–‡
                </div>
                <div class="opt-divider"></div>
                <div class="opt-item" id="opt-auth-item" onclick="handleAuthAction()">
                    <span class="opt-icon">ğŸ‘‹</span> ç™»å‡ºå¸³è™Ÿ
                </div>
                <div class="opt-item" onclick="optAction('version')">
                    <span class="opt-icon">â„¹ï¸</span> ç‰ˆæœ¬: v1.7.0 Stable
                </div>
            </div>

        </header>

        <div id="ghost-ticker">
            <div class="ticker-content" id="ticker-text"></div>
        </div>

        <main class="main-scroll-area">
             </main>

        <div id="slots-panel" class="dashboard-panel gradient-border-box">
            <div class="panel-header">
                <div class="tab-item active">å…¨éƒ¨</div>
                <div class="tab-item">ç†±é–€ ğŸ”¥</div>
                <div class="tab-item">æ–°éŠæˆ² ğŸ’</div>
                <div class="tab-item">æœ€æ„› â¤ï¸</div>
            </div>
            <div class="panel-content">
                <div class="slots-grid">
                     </div>
            </div>
            <div class="panel-footer">
                <div class="close-gold-btn" id="close-slots-btn">CLOSE</div>
            </div>
        </div>

        <div id="rewards-panel" class="dashboard-panel gradient-border-box">
            <div class="rewards-tabs">
                <div class="r-tab-btn active" onclick="switchRewardTab('daily')">æ¯æ—¥ç°½åˆ°</div>
                <div class="r-tab-btn" onclick="switchRewardTab('mail')">ä¿¡ç®±</div>
                <div class="r-tab-btn" onclick="switchRewardTab('gift')">é€ç¦®</div>
            </div>

            <div class="rewards-content">
                
                <div id="view-daily" class="r-view active">
                    <div class="daily-grid" id="daily-grid-container">
                        </div>
                </div>

                <div id="view-mail" class="r-view">
                    <div class="compose-btn-container">
                        <button class="compose-btn" onclick="toggleComposeView(true)">âœï¸ å¯«ä¿¡</button>
                    </div>
                    <div class="mail-list" id="mail-list-container">
                        <div style="text-align:center; color:#888; padding:20px;">è¼‰å…¥ä¿¡ä»¶ä¸­...</div>
                    </div>
                </div>

                <div id="view-compose" class="r-view">
                    <div class="gift-container">
                        <h3 style="color:#fff;">å¯„ä¿¡çµ¦å¥½å‹</h3>
                        <div class="gift-input-group">
                            <span class="gift-label">æ”¶ä»¶äººæš±ç¨±</span>
                            <input type="text" id="compose-to" class="gift-input" placeholder="è¼¸å…¥ç©å®¶æš±ç¨±...">
                        </div>
                        <div class="gift-input-group">
                            <span class="gift-label">ä¿¡ä»¶å…§å®¹</span>
                            <textarea id="compose-msg" class="gift-input gift-textarea" placeholder="æƒ³èªªäº›ä»€éº¼..."></textarea>
                        </div>
                        <button class="send-btn" onclick="sendUserMail()">ç™¼é€éƒµä»¶</button>
                        <button class="w-btn cancel" onclick="toggleComposeView(false)" style="margin-top:10px;">è¿”å›åˆ—è¡¨</button>
                    </div>
                </div>

                <div id="view-gift" class="r-view">
                    <div class="gift-container">
                        <img src="player.png" style="width: 80px; border-radius:50%; border:2px solid #ffd700;">
                        <div style="color:#fff; font-weight:bold;">è´ˆé€é‡‘å¹£çµ¦å¥½å‹</div>
                        <div class="gift-input-group">
                            <span class="gift-label">å¥½å‹ ID / E-mail</span>
                            <input type="text" class="gift-input" placeholder="è¼¸å…¥ç©å®¶ ID...">
                        </div>
                        <div class="gift-input-group">
                            <span class="gift-label">è´ˆé€é‡‘é¡</span>
                            <select class="gift-input">
                                <option>1,000 é‡‘å¹£</option>
                                <option>5,000 é‡‘å¹£</option>
                                <option>10,000 é‡‘å¹£</option>
                                <option>100,000 é‡‘å¹£</option> </select>
                        </div>
                        <button class="send-btn" onclick="sendGift()">ç¢ºèªç™¼é€</button>
                    </div>
                </div>
            </div>
            <div class="panel-footer">
                <div class="close-gold-btn" id="close-rewards-btn">CLOSE</div>
            </div>
        </div>

        <div id="profile-panel" class="dashboard-panel gradient-border-box">
            <div class="profile-header">
                <img src="player.png" class="p-avatar">
                <div class="p-info"><div class="p-name">Loading...</div><div class="p-id">ID: ---</div></div>
                <div class="vip-container">
                    <div class="vip-labels"><span>VIP.1</span><span>VIP.2</span></div>
                    <div class="vip-track"><div class="vip-fill"></div></div>
                </div>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                <div class="stats-grid">
                    <div class="stat-box" style="text-align: left; padding: 12px; display: flex; flex-direction: column; justify-content: center;">
                        <div class="stat-label" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px;">ğŸ“… æ—¥æœŸç´€éŒ„</div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">å‰µå»º: <span id="stat-join-date" style="color: #fff; float: right;">---</span></div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">å‡ç´š: <span id="stat-last-levelup" style="color: #fff; float: right;">---</span></div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">ä»Šå¤©: <span id="stat-today" style="color: #00ff00; float: right;">---</span></div>
                    </div>
                    
                    <div class="stat-box" style="text-align: left; padding: 12px; display: flex; flex-direction: column; justify-content: center;">
                        <div class="stat-label" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; margin-bottom: 5px;">ğŸ° éŠç©ç´€éŒ„</div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">æœ€å¸¸: <span id="stat-fav-game" style="color: #ffd700; float: right;">Dragon's Treasure</span></div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">ä¸Šæ¬¡: <span id="stat-last-game" style="color: #ffd700; float: right;">Dragon's Treasure</span></div>
                        <div style="font-size: 1.3vh; color: #aaa; margin: 2px 0;">å±€æ•¸: <span id="stat-total-spins" style="color: #00ffff; float: right;">0</span></div>
                    </div>
                </div>
                <div class="settings-list">
                    <div class="setting-item">
                        <span class="setting-label">èƒŒæ™¯éŸ³æ¨‚</span>
                        <label class="toggle-switch-small">
                            <input type="checkbox" id="bgm-toggle" checked>
                            <span class="slider-small"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span class="setting-label">éŠæˆ²éŸ³æ•ˆ</span>
                        <label class="toggle-switch-small">
                            <input type="checkbox" id="sfx-toggle" checked>
                            <span class="slider-small"></span>
                        </label>
                    </div>
                    <div class="setting-item" onclick="changePassword()" style="cursor: pointer;">
                        <span class="setting-label">ğŸ” ä¿®æ”¹å¯†ç¢¼</span>
                        <div style="color: #aaa; font-size: 1.4vh;">é»æ“Šä¿®æ”¹ ></div>
                    </div>
                    </div>
                <div class="logout-btn" onclick="logout()">ç™»å‡ºå¸³è™Ÿ</div>
            </div>
            <div class="panel-footer">
                <div class="close-gold-btn" id="close-profile-btn">CLOSE</div>
            </div>
        </div>

        <div id="rankings-panel" class="dashboard-panel gradient-border-box">
            <div class="profile-header">
                <img src="Rankings.png" style="width: 60px; height: auto;">
                <h2 style="color: #ffd700; margin: 5px 0 0 0;">å¯Œè±ªæ’è¡Œæ¦œ</h2>
                <div style="color:#888; font-size:1.2vh;">Top Wealthy Players</div>
            </div>
            <div class="panel-content">
                <div class="rank-list" id="rank-list-content">
                    <div style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</div>
                </div>
            </div>
            <div class="panel-footer">
                <div class="close-gold-btn" id="close-rankings-btn">CLOSE</div>
            </div>
        </div>

        <div id="wallet-modal">
            <div class="wallet-box">
                <div class="w-header"><div class="w-title">å„²å€¼ä¸­å¿ƒ</div><div class="w-balance">ç•¶å‰é¤˜é¡: ---</div></div>
                <div class="w-grid">
                    <div class="w-option" onclick="selectRecharge(this, 100000)"><span class="w-coins">100,000</span><span class="w-price">$0.99</span></div>
                    <div class="w-option active" onclick="selectRecharge(this, 500000)"><span class="w-coins">500,000</span><span class="w-price">$4.99</span></div>
                    <div class="w-option" onclick="selectRecharge(this, 1200000)"><span class="w-coins">1,200,000</span><span class="w-price">$9.99</span></div>
                    <div class="w-option" onclick="selectRecharge(this, 6500000)"><span class="w-coins">6,500,000</span><span class="w-price">$49.99</span></div>
                </div>
                <div class="w-actions">
                    <button class="w-btn cancel" id="close-wallet-btn">å–æ¶ˆ</button>
                    <button class="w-btn confirm" onclick="confirmRecharge()">ç«‹å³æ”¯ä»˜</button>
                </div>
            </div>
        </div>

        <div id="auth-modal"> 
            <div class="wallet-box" style="width: 40vh; max-width: 90%;">
                <div class="w-header">
                    <div class="w-title" id="auth-title">ç™»å…¥ / è¨»å†Š</div>
                    <div class="w-balance" style="color:#aaa;">æ­¡è¿å›åˆ° Casino Lobby</div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <span class="gift-label">å¸³è™Ÿ (æš±ç¨±)</span>
                        <input type="text" id="auth-name" class="gift-input" placeholder="æš±ç¨±" style="background: rgba(0,0,0,0.5);">
                    </div>
                    <div>
                        <span class="gift-label">å¯†ç¢¼</span>
                        <input type="password" id="auth-pass" class="gift-input" placeholder="å¯†ç¢¼" style="background: rgba(0,0,0,0.5);">
                    </div>
                </div>

                <div class="auth-actions-grid">
                    <button class="w-btn confirm" onclick="doLogin()">ç™»å…¥</button>
                    <button class="w-btn cancel" style="background: rgba(255,255,255,0.15); color: #ddd;" onclick="doGuestLogin()">è¨ªå®¢è©¦ç©</button>
                    <button class="w-btn confirm btn-full-width" style="background: linear-gradient(90deg, #4b0082, #8a2be2); color:#fff; margin-top:5px;" onclick="doRegister()">è¨»å†Šæ–°å¸³è™Ÿ</button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav gradient-border-box">
            <div class="nav-item active" id="nav-home">
                <img src="home.png" class="nav-icon" alt="Home">
                <span class="nav-label">Home</span>
            </div>
            <div class="nav-item" id="nav-slots">
                <img src="games.png" class="nav-icon" alt="Slots">
                <span class="nav-label">Slots</span>
            </div>
            <div class="nav-item" id="nav-rankings">
                <img src="Rankings.png" class="nav-icon" alt="Rankings">
                <span class="nav-label">Rank</span>
            </div>
            <div class="nav-item" id="nav-rewards">
                <img src="events.png" class="nav-icon" alt="Rewards">
                <span class="nav-label">Rewards</span>
            </div>
            <div class="nav-item" id="nav-profile">
                <img src="profile.png" class="nav-icon" alt="Profile">
                <span class="nav-label">Profile</span>
            </div>
        </nav>
    </div>

    <div id="transition-overlay"></div>
    <div id="game-container">
        <button id="close-game-btn">âœ•</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // --- 1. Firebase Configuration & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyA13JH6n_YRY2Rtiuq2u3iN4mEe5cQL8Bo",
            authDomain: "casino-lobby-123f5.firebaseapp.com",
            projectId: "casino-lobby-123f5",
            storageBucket: "casino-lobby-123f5.firebasestorage.app",
            messagingSenderId: "433397567788",
            appId: "1:433397567788:web:197a552bba01b186dedc89"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database(); // â˜… å…¨åŸŸè®Šæ•¸ db

        // --- 2. User Logic with Firebase (å…¨æ–°å¸³è™Ÿå¯†ç¢¼ç‰ˆ) ---
        let currentUser = null;
        let myUserId = localStorage.getItem('casino_firebase_uid');
        let guestSessionId = sessionStorage.getItem('casino_guest_id');
        let currentMailsCache = []; 

        // â˜… Audio Controller
        const LobbyAudio = {
            bgm: document.getElementById('bgm_lobby'),
            sfxClick: document.getElementById('sfx_click'),
            sfxTake: document.getElementById('sfx_take'),   
            sfxMoney: document.getElementById('sfx_money'), 
            isMuted: false,
            hasInteracted: false, 
            isFading: false, 

            init: function() {
                const savedMute = localStorage.getItem('lobby_mute');
                if (savedMute === 'true') {
                    this.isMuted = true;
                    const toggle = document.getElementById('bgm-toggle');
                    if(toggle) toggle.checked = false;
                }
                
                if(this.bgm) this.bgm.volume = 0.5;
                if(this.sfxClick) this.sfxClick.volume = 1.0;
                if(this.sfxTake) this.sfxTake.volume = 1.0;   
                if(this.sfxMoney) this.sfxMoney.volume = 1.0; 

                // æ”¹æˆ pointerdown ææ—©è§¸ç™¼
                document.body.addEventListener('pointerdown', () => { 
                    if (!this.hasInteracted) {
                        this.hasInteracted = true;
                        this.playBGM();
                    }
                }, { once: true });
                
                const toggle = document.getElementById('bgm-toggle');
                if(toggle) {
                    toggle.addEventListener('change', (e) => {
                        this.toggleMute(!e.target.checked);
                    });
                }

                if(this.bgm) {
                     var promise = this.bgm.play();
                     if (promise !== undefined) {
                        promise.catch(error => {
                            console.log("Autoplay prevented by browser policy.");
                        });
                     }
                }

                this.bgm.addEventListener('timeupdate', () => {
                    if(this.isFading) return; 
                    if(!this.bgm.duration) return;
                    const timeLeft = this.bgm.duration - this.bgm.currentTime;
                    
                    if(timeLeft <= 5) {
                        this.bgm.volume = Math.max(0, timeLeft / 5 * 0.5); 
                    } else if (this.bgm.volume < 0.5 && !this.isMuted) {
                        this.bgm.volume = 0.5;
                    }
                });
            },

            fadeOut: function() {
                if(!this.bgm) return;
                this.isFading = true;
                let safetyCounter = 20; 
                
                if(this.fadeInterval) clearInterval(this.fadeInterval);
                this.fadeInterval = setInterval(() => {
                    if (this.bgm.volume > 0.05) {
                        try { this.bgm.volume -= 0.05; } catch(e) {}
                    }
                    safetyCounter--;
                    if (this.bgm.volume <= 0.05 || safetyCounter <= 0) {
                        this.bgm.pause();
                        this.bgm.volume = 0.5; 
                        clearInterval(this.fadeInterval);
                        this.isFading = false;
                    }
                }, 50); 
            },

            playBGM: function() {
                if (!this.isMuted && this.bgm) {
                    this.isFading = true;
                    try { this.bgm.volume = 0; } catch(e) {} 
                    
                    this.bgm.play().catch(e => console.log("Waiting interaction..."));
                    
                    if(this.fadeInterval) clearInterval(this.fadeInterval);
                    
                    let safetyCounter = 20;
                    this.fadeInterval = setInterval(() => {
                        if (this.bgm.volume < 0.5) {
                            try { this.bgm.volume += 0.05; } catch(e) {}
                        }
                        safetyCounter--;
                        if (this.bgm.volume >= 0.5 || safetyCounter <= 0) {
                            try { if(this.bgm.volume < 0.5) this.bgm.volume = 0.5; } catch(e) {}
                            clearInterval(this.fadeInterval);
                            this.isFading = false;
                        }
                    }, 50);
                }
            },

            playClick: function() {
                if (!this.isMuted && this.sfxClick) {
                    this.sfxClick.currentTime = 0;
                    this.sfxClick.play().catch(()=>{});
                }
            },

            playTake: function() {
                if (!this.isMuted && this.sfxTake) {
                    this.sfxTake.currentTime = 0;
                    this.sfxTake.play().catch(()=>{});
                }
            },

            playMoney: function() {
                if (!this.isMuted && this.sfxMoney) {
                    this.sfxMoney.currentTime = 0;
                    this.sfxMoney.play().catch(()=>{});
                }
            },

            toggleMute: function(muteState) {
                this.isMuted = muteState;
                localStorage.setItem('lobby_mute', muteState);
                if (muteState) {
                    if(this.bgm) this.bgm.pause();
                } else {
                    if(this.bgm && this.hasInteracted) this.bgm.play();
                }
            }
        };

        // â˜… å…¨åŸŸè®Šæ•¸/å‡½å¼å®šç¾©å€
        
        function initUser() {
            // 1. å¼·åˆ¶æ¸…é™¤èˆŠçš„ç™»å…¥ç´€éŒ„
            localStorage.removeItem('casino_firebase_uid');
            sessionStorage.removeItem('casino_guest_id');

            // 2. ç›´æ¥å‘¼å«ç™»å…¥è¦–çª—
            showAuthModalWithDelay();
        } 

        function showAuthModalWithDelay() {
            const authModal = document.getElementById('auth-modal');
            setTimeout(() => { authModal.classList.add('active'); }, 800); 
        }

        window.doLogin = function() {
            const name = document.getElementById('auth-name').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!name || !pass) { alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"); return; }

            db.ref('players').orderByChild('name').equalTo(name).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    let foundUser = false;
                    snapshot.forEach(child => {
                        const userData = child.val();
                        if (userData.password === pass) {
                            foundUser = true;
                            myUserId = child.key;
                            localStorage.setItem('casino_firebase_uid', myUserId);
                            sessionStorage.removeItem('casino_guest_id'); 
                            currentUser = userData;
                            document.getElementById('auth-modal').classList.remove('active');
                            updateUserUI();
                            startTickerListener();
                            listenUserData();
                            alert("æ­¡è¿å›ä¾†ï¼Œ" + userData.name + "ï¼");
                        }
                    });
                    if (!foundUser) alert("å¯†ç¢¼éŒ¯èª¤ï¼");
                } else {
                    alert("æ‰¾ä¸åˆ°æ­¤å¸³è™Ÿï¼Œè«‹å…ˆè¨»å†Šã€‚");
                }
            });
        }

        window.doGuestLogin = function() {
            const guestId = 'guest_' + Date.now();
            const guestUser = { name: "Guest", balance: 10000, vip: 0, isGuest: true };
            
            db.ref('players/' + guestId).set(guestUser, (error) => {
                if(!error) {
                    sessionStorage.setItem('casino_guest_id', guestId);
                    myUserId = guestId;
                    currentUser = guestUser;
                    db.ref('players/' + guestId).onDisconnect().remove();
                    document.getElementById('auth-modal').classList.remove('active');
                    updateUserUI();
                    startTickerListener();
                    listenUserData();
                    alert("å·²é€²å…¥è¨ªå®¢æ¨¡å¼\n(æ³¨æ„ï¼šé—œé–‰åˆ†é æˆ–é‡æ•´å°‡æœƒæ¸…é™¤è³‡æ–™)");
                }
            });
        }

        window.doRegister = function() {
            const name = document.getElementById('auth-name').value.trim();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!name || !pass) { alert("è«‹è¼¸å…¥å¸³è™Ÿèˆ‡å¯†ç¢¼"); return; }

            db.ref('players').orderByChild('name').equalTo(name).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    alert("é€™å€‹æš±ç¨±å·²ç¶“æœ‰äººä½¿ç”¨äº†ï¼Œè«‹æ›ä¸€å€‹ï¼"); return;
                }
                const newId = 'user_' + Date.now();
                const newUser = {
                    name: name,
                    password: pass,
                    balance: 100000, 
                    vip: 1,
                    exp: 0,  // åˆå§‹ç¶“é©—å€¼
                    joinedAt: Date.now(),
                    lastLoginDate: 0, 
                    loginStreak: 0
                };
                db.ref('players/' + newId).set(newUser, (error) => {
                    if (error) {
                        alert("è¨»å†Šå¤±æ•—ï¼š" + error.message);
                    } else {
                        alert("è¨»å†ŠæˆåŠŸï¼ç²å¾—é«”é©—é‡‘ 100,000");
                        myUserId = newId;
                        localStorage.setItem('casino_firebase_uid', myUserId);
                        sessionStorage.removeItem('casino_guest_id');
                        currentUser = newUser;
                        document.getElementById('auth-modal').classList.remove('active');
                        updateUserUI();
                        startTickerListener();
                        listenUserData();
                    }
                });
            });
        }

        // â˜… ä¿®æ”¹å¾Œï¼šæ¯æ—¥ç°½åˆ° (åªé€éŒ¢ï¼Œç¶“é©—æ”¹ç”±ä¸‹æ³¨ç´¯ç©)
        window.claimDaily = function(element, amount) { 
            if(currentUser.isGuest) { alert("è¨ªå®¢ç„¡æ³•ä½¿ç”¨çå‹µåŠŸèƒ½"); return; }
            if(element.classList.contains('claimed')) return; 
            if(element.classList.contains('normal')) return; 

            const today = new Date().setHours(0,0,0,0);
            let streak = currentUser.loginStreak || 0;
            const lastDate = currentUser.lastLoginDate || 0;

            // å¦‚æœä¸­æ–·ç°½åˆ°ï¼Œé‡ç½®
            const oneDay = 86400000;
            if (today - lastDate > oneDay && lastDate !== 0) { streak = 0; }

            streak++; 
            
            // è¨ˆç®—çé‡‘
            let baseBonus = 10000;
            let vipBonus = (currentUser.vip || 1) * 5000; 
            let bonus = baseBonus + vipBonus;
            
            let msg = `ğŸ‰ ç°½åˆ°æˆåŠŸï¼ç²å¾— ${bonus.toLocaleString()} é‡‘å¹£\n(VIPåŠ æˆ: ${vipBonus})`;

            if (streak >= 7) {
                bonus = 100000 + vipBonus; // ç¬¬ä¸ƒå¤©å¤§ç
                streak = 0; 
                msg = `ğŸ”¥ é€£çºŒç°½åˆ° 7 å¤©ï¼ç²å¾—å¤§ç ${bonus.toLocaleString()} é‡‘å¹£ï¼`;
            }

            db.ref('players/' + myUserId).update({
                balance: (currentUser.balance || 0) + bonus,
                lastLoginDate: today,
                loginStreak: streak
            }).then(() => {
                LobbyAudio.playTake(); 
                alert(msg);
                renderRewards(); 
                updateUserUI(); 
            });
        }

        function renderRewards() {
            const container = document.getElementById('daily-grid-container');
            if(!container || !currentUser) return;
            container.innerHTML = ''; 
            
            let streak = currentUser.loginStreak || 0;
            const lastDate = currentUser.lastLoginDate || 0;
            const today = new Date().setHours(0,0,0,0);
            const claimedToday = (lastDate === today);

            // å¦‚æœä¸­æ–·è¶…éä¸€å¤©ï¼Œé‡ç½®ç°½åˆ°é€²åº¦
            const oneDay = 86400000;
            if (today - lastDate > oneDay && lastDate !== 0) { streak = 0; }

            // â˜… æ‰¾å‡ºã€Œç•¶å‰æ‡‰è©²é ˜å“ªä¸€æ ¼ã€
            let targetDay = streak + 1;
            if (claimedToday) targetDay = streak + 1; 

            for(let i=1; i<=7; i++) {
                let stateClass = 'normal'; 
                
                if (i <= streak) {
                    stateClass = 'claimed';
                } else if (i === streak + 1) {
                    if (claimedToday) stateClass = 'normal'; 
                    else stateClass = 'active'; // ä»Šå¤©é‚„æ²’é ˜ï¼Œå°±æ˜¯ç¾åœ¨ï¼
                } else {
                    stateClass = 'normal';
                }

                let valText = (i === 7) ? '100,000' : '10,000';
                let imgHtml = (i === 7) ? '<img src="events.png" class="day-coin-img" style="width: 15%; opacity:0.8">' : '<img src="gold.png" class="day-coin-img">';
                let extraClass = (i === 7) ? 'day-7' : '';
                let title = (i === 7) ? 'Day 7 - MEGA BOX' : `Day ${i}`;

                let div = document.createElement('div');
                div.className = `day-box ${extraClass} ${stateClass}`;
                div.innerHTML = `<span class="day-num">${title}</span>${imgHtml}<span class="day-val">${valText}</span>`;
                
                // â˜… ç¶å®šé»æ“Šäº‹ä»¶ (åªæœ‰ active ç‹€æ…‹æ‰ç¶å®š)
                if(stateClass === 'active') {
                    div.onclick = function() { claimDaily(this, 0); };
                }
                container.appendChild(div);
            }
        }

        function initMailboxListener() {
            if(!myUserId) return;
            db.ref('players/' + myUserId + '/mailbox').on('value', (snapshot) => {
                const mails = [];
                snapshot.forEach(child => { mails.push({ id: child.key, ...child.val() }); });
                const systemMails = getSystemMails();
                const allMails = [...systemMails, ...mails];
                allMails.sort((a, b) => b.date - a.date);
                currentMailsCache = allMails; 
                renderMailList(allMails);
            });
        }

        function getSystemMails() {
            const deletedMap = currentUser ? (currentUser.deleted_sys_mails || {}) : {};
            const sysMails = [
                { id: 'sys_001', title: 'ç¶­è­·è£œå„Ÿçå‹µ', content: 'æ„Ÿè¬æ‚¨çš„è€å¿ƒç­‰å¾…ï¼Œè£œå„Ÿ 500 é‡‘å¹£', reward: 500, date: 1735538400000, type: 'system', isRead: false },
                { id: 'sys_002', title: 'ç«é¾ç¥•å¯¶ - æ–°æ©Ÿä¸Šç·š!', content: 'å…¨æ–°æ©Ÿå°ç«ç†±ä¸Šç·šï¼Œç™»å…¥å³é€ 1000 é‡‘å¹£', reward: 1000, date: 1735452000000, type: 'system', isRead: false }
            ];
            return sysMails.filter(m => !deletedMap[m.id]);
        }

        function renderMailList(mails) {
            const container = document.getElementById('mail-list-container');
            container.innerHTML = '';
            if (mails.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#666; margin-top:20px;">æš«ç„¡ä¿¡ä»¶</div>';
                updateMailTabCount(0);
                return;
            }
            let unreadCount = 0;
            mails.forEach(mail => {
                let isRead = mail.isRead;
                if(mail.type === 'system') {
                    if (currentUser && currentUser.claimed_sys_mails && currentUser.claimed_sys_mails[mail.id]) isRead = true;
                }
                if (!isRead) unreadCount++;

                const div = document.createElement('div');
                div.className = `mail-item ${isRead ? 'read' : 'unread'}`;
                let icon = 'âœ‰ï¸';
                if (mail.type === 'gift') icon = 'ğŸ’°';
                else if (mail.type === 'system') icon = mail.reward ? 'ğŸ' : 'ğŸ”¥';

                div.innerHTML = `
                    <div class="mail-content-wrapper" onclick="openMail('${mail.id}')">
                        <div class="mail-icon">${icon}</div>
                        <div class="mail-info">
                            <div class="mail-title">${mail.title}</div>
                            <div class="mail-date">${new Date(mail.date).toLocaleDateString()}</div>
                        </div>
                        <div class="mail-status">${isRead ? 'å·²è®€' : 'æœªè®€'}</div>
                    </div>
                    <div class="mail-delete-btn" onclick="deleteMail('${mail.id}', '${mail.type}')">ğŸ—‘ï¸</div>
                `;
                container.appendChild(div);
            });
            updateMailTabCount(unreadCount);
        }

        window.openMail = function(id) {
            let mail = currentMailsCache.find(m => m.id === id);
            if (!mail && currentUser.mailbox) {
                mail = currentUser.mailbox[id];
                if (mail) mail.id = id; 
            }
            if (!mail) return; 

            const { type, reward, title, content } = mail;
            let msg = `${title}\n\n${content}`;
            
            if (type === 'system') {
                const isClaimed = currentUser.claimed_sys_mails && currentUser.claimed_sys_mails[id];
                if (!isClaimed) {
                    const updates = {};
                    updates['balance'] = (currentUser.balance || 0) + reward;
                    updates['claimed_sys_mails/' + id] = true;
                    db.ref('players/' + myUserId).update(updates).then(() => {
                        if (reward > 0) { LobbyAudio.playTake(); alert(msg + `\n\n(å·²é ˜å–é™„ä»¶: ${reward} é‡‘å¹£)`); } 
                        else { alert(msg); }
                    });
                } else { alert(msg + "\n\n(å·²è®€/å·²é ˜å–)"); }
            } else if (type === 'gift') {
                if (mail.claimed) { alert(msg + "\n\n(å·²é ˜å–)"); } 
                else {
                    const updates = {};
                    updates['balance'] = (currentUser.balance || 0) + reward;
                    updates['mailbox/' + id + '/claimed'] = true;
                    updates['mailbox/' + id + '/isRead'] = true;
                    db.ref('players/' + myUserId).update(updates).then(() => {
                        LobbyAudio.playTake();
                        alert(msg + `\n\n(å·²é ˜å–é™„ä»¶: ${reward} é‡‘å¹£)`);
                    });
                }
            } else {
                if(!mail.isRead) db.ref('players/' + myUserId + '/mailbox/' + id).update({ isRead: true });
                alert(msg);
            }
        };

        window.deleteMail = function(id, type) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™å°ä¿¡å—ï¼Ÿ")) return;
            if (type === 'system') db.ref('players/' + myUserId + '/deleted_sys_mails/' + id).set(true);
            else db.ref('players/' + myUserId + '/mailbox/' + id).remove();
        }

        function updateMailTabCount(count) {
            const mailTabBtn = document.querySelectorAll('.r-tab-btn')[1]; 
            if (mailTabBtn) mailTabBtn.innerText = count > 0 ? `ä¿¡ç®± (${count})` : "ä¿¡ç®±";
        }

        window.toggleComposeView = function(show) {
            if(show) {
                document.querySelector('#view-mail').classList.remove('active');
                document.querySelector('#view-compose').classList.add('active');
            } else {
                document.querySelector('#view-compose').classList.remove('active');
                document.querySelector('#view-mail').classList.add('active');
            }
        }

        window.sendUserMail = function() {
            const toName = document.getElementById('compose-to').value.trim();
            const content = document.getElementById('compose-msg').value.trim();
            if(!toName || !content) { alert("è«‹å¡«å¯«æ”¶ä»¶äººå’Œå…§å®¹"); return; }
            if(toName === currentUser.name) { alert("ä¸èƒ½å¯„çµ¦è‡ªå·±"); return; }

            db.ref('players').orderByChild('name').equalTo(toName).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    let receiverId = null;
                    snapshot.forEach(child => { receiverId = child.key; });
                    if(receiverId) {
                        const newMail = {
                            title: `ä¾†è‡ª ${currentUser.name} çš„è¨Šæ¯`,
                            content: content,
                            date: Date.now(),
                            isRead: false,
                            type: 'user',
                            sender: currentUser.name
                        };
                        db.ref('players/' + receiverId + '/mailbox').push(newMail).then(() => {
                            alert("ä¿¡ä»¶å·²ç™¼é€ï¼");
                            toggleComposeView(false);
                            document.getElementById('compose-to').value = '';
                            document.getElementById('compose-msg').value = '';
                        });
                    }
                } else { alert("æ‰¾ä¸åˆ°è©²ç©å®¶"); }
            });
        }

        window.sendGift = function() {
            if(currentUser.isGuest) { alert("è¨ªå®¢ç„¡æ³•ä½¿ç”¨é€ç¦®åŠŸèƒ½"); return; }
            const receiverInput = document.querySelector('#view-gift .gift-input[type="text"]');
            const amountSelect = document.querySelector('#view-gift .gift-input:not([type="text"])');
            const receiverName = receiverInput.value.trim();
            const amountStr = amountSelect.value.replace(/[^0-9]/g, '');
            const amount = parseInt(amountStr);

            if (!receiverName) { alert("è«‹è¼¸å…¥å°æ–¹ ID æˆ–æš±ç¨±"); return; }
            if (currentUser.balance < amount) { alert("æ‚¨çš„é¤˜é¡ä¸è¶³ï¼"); return; }
            if (receiverName === currentUser.name) { alert("ä¸èƒ½é€çµ¦è‡ªå·±å•¦ï¼"); return; }

            db.ref('players').orderByChild('name').equalTo(receiverName).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    let receiverId = null;
                    snapshot.forEach(child => { receiverId = child.key; });
                    if (receiverId) {
                        db.ref('players/' + myUserId + '/balance').transaction((currentBalance) => {
                            if (currentBalance >= amount) return currentBalance - amount;
                            return currentBalance; 
                        }, (error, committed, snapshot) => {
                            if (error) { alert("äº¤æ˜“å¤±æ•—"); } 
                            else if (!committed) { alert("é¤˜é¡ä¸è¶³ï¼Œäº¤æ˜“å–æ¶ˆ"); } 
                            else {
                                const newMail = {
                                    title: "ğŸ’° å¥½å‹è´ˆç¦®",
                                    content: `ç©å®¶ ${currentUser.name} è´ˆé€çµ¦æ‚¨ ${amount.toLocaleString()} é‡‘å¹£ï¼\nè«‹é»æ“Šé ˜å–ã€‚`,
                                    reward: amount,
                                    date: Date.now(),
                                    isRead: false,
                                    type: 'gift', 
                                    sender: currentUser.name,
                                    claimed: false
                                };
                                db.ref('players/' + receiverId + '/mailbox').push(newMail);
                                LobbyAudio.playMoney(); 
                                alert(`æˆåŠŸç™¼é€ ${amount.toLocaleString()} é‡‘å¹£çµ¦ ${receiverName}ï¼`);
                                receiverInput.value = ''; 
                            }
                        });
                    }
                } else { alert("æ‰¾ä¸åˆ°é€™ä½ç©å®¶ï¼Œè«‹ç¢ºèªæš±ç¨±æ˜¯å¦æ­£ç¢ºã€‚"); }
            });
        }

        window.handleAuthAction = function() {
            if (currentUser && currentUser.isGuest) {
                document.getElementById('auth-modal').classList.add('active');
            } else { logout(); }
        }

        function logout() {
            if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
                if (currentUser && currentUser.isGuest) {
                    db.ref('players/' + myUserId).remove().then(() => {
                        localStorage.removeItem('casino_firebase_uid');
                        sessionStorage.removeItem('casino_guest_id');
                        location.reload();
                    });
                } else {
                    localStorage.removeItem('casino_firebase_uid');
                    const guestId = 'guest_' + Date.now();
                    const guestUser = { name: "Guest", balance: 10000, vip: 0, isGuest: true };
                    db.ref('players/' + guestId).set(guestUser).then(() => {
                        sessionStorage.setItem('casino_guest_id', guestId);
                        location.reload(); 
                    });
                }
            }
        }

        window.optAction = function(type) {
            document.getElementById('option-dropdown').classList.remove('active');
            if (type === 'support') alert("æ­£åœ¨ç‚ºæ‚¨é€£ç·šç·šä¸Šå®¢æœ...");
            else if (type === 'history') alert("ğŸ“Š æŠ•æ³¨ç´€éŒ„åŠŸèƒ½é–‹ç™¼ä¸­");
            else if (type === 'lang') alert("Language switched.");
            else if (type === 'version') alert("Casino Lobby\nv1.7.0 Stable");
        }

        window.switchRewardTab = function(tabName) {
            const btns = document.querySelectorAll('.r-tab-btn');
            btns.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.r-view').forEach(v => v.classList.remove('active'));
            if(tabName === 'mail') {
                document.getElementById('view-compose').classList.remove('active');
                document.getElementById('view-mail').classList.add('active');
            } else {
                document.getElementById(`view-${tabName}`).classList.add('active');
            }
        }

        window.selectRecharge = function(el, amount) {
            document.querySelectorAll('.w-option').forEach(opt => opt.classList.remove('active'));
            el.classList.add('active');
        }

        window.confirmRecharge = function() {
            document.getElementById('wallet-modal').classList.remove('active');
            alert("ç³»çµ±æç¤ºï¼šæ­£åœ¨é€£ç·šè‡³æ”¯ä»˜é–˜é“... (æ¨¡æ“¬æˆåŠŸ)");
            updateUserBalance(500000); 
        }

        function listenUserData() {
            if(!myUserId) return;
            db.ref('players/' + myUserId).on('value', (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    currentUser = data;
                    updateUserUI();
                    
                    if(currentMailsCache.length > 0) {
                         const mailRef = db.ref('players/' + myUserId + '/mailbox');
                         mailRef.once('value', (snap) => {
                            const mails = [];
                            snap.forEach(child => { mails.push({ id: child.key, ...child.val() }); });
                            const systemMails = getSystemMails();
                            const allMails = [...systemMails, ...mails];
                            allMails.sort((a, b) => b.date - a.date);
                            currentMailsCache = allMails; 
                            renderMailList(allMails);
                         });
                    }
                } else { location.reload(); }
            });
            initMailboxListener();
        }

        function startTickerListener() {
            db.ref('system/ticker').on('value', (snapshot) => {
                const msg = snapshot.val();
                if(msg) {
                    showGhostTicker(msg);
                    const gameFrame = document.getElementById('game-frame');
                    if (gameFrame && gameFrame.contentWindow) {
                        gameFrame.contentWindow.postMessage({ type: 'tickerMessage', msg: msg }, '*');
                    }
                }
            });
        }

        function showGhostTicker(msg) {
            const ticker = document.getElementById('ghost-ticker');
            const text = document.getElementById('ticker-text');
            text.innerText = msg;
            text.style.animation = 'none'; 
            ticker.offsetHeight; 
            ticker.classList.add('active');
            setTimeout(() => { text.style.animation = 'scrollText 10s linear forwards'; }, 100);
            setTimeout(() => { ticker.classList.remove('active'); }, 10000);
        }

        function updateUserUI() {
            if(!currentUser) return;

            // 1. æ›´æ–°æ–‡å­—æ•¸æ“š
            document.querySelector('.coin-number').innerText = currentUser.balance.toLocaleString('en-US', {minimumFractionDigits: 2});
            document.querySelector('.p-name').innerText = currentUser.name;
            document.querySelector('.p-id').innerText = "ID: " + currentUser.name;
            document.querySelector('.w-balance').innerText = "ç•¶å‰é¤˜é¡: " + currentUser.balance.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            // â˜…â˜…â˜… æ–°å¢ï¼šæ›´æ–° Profile çš„è©³ç´°æ•¸æ“š â˜…â˜…â˜…
            // 1. æ—¥æœŸæ ¼å¼åŒ– helper
            const formatDate = (ts) => {
                if (!ts) return "---";
                return new Date(ts).toLocaleDateString(); // æ ¼å¼åƒ 2025/1/6
            };

            // 2. å¡«å…¥æ•¸æ“š (å¦‚æœæœ‰æ‰¾åˆ°å°æ‡‰çš„ element)
            if(document.getElementById('stat-join-date')) {
                document.getElementById('stat-join-date').innerText = formatDate(currentUser.joinedAt);
                
                // â˜… ä¿®æ”¹è™•ï¼šå°‡åŸæœ¬çš„ stat-last-login æ”¹ç‚º stat-last-levelup (ä¸Šæ¬¡å‡ç´š)
                const levelUpDate = currentUser.lastLevelUpDate ? formatDate(currentUser.lastLevelUpDate) : "---";
                document.getElementById('stat-last-levelup').innerText = levelUpDate;
                
                document.getElementById('stat-today').innerText = formatDate(Date.now());
                
                // æš«æ™‚åªæœ‰ä¸€æ¬¾éŠæˆ²ï¼Œæ‰€ä»¥å…ˆå¯«æ­»ï¼Œæœªä¾†å¯å¾è³‡æ–™åº«è®€å–
                document.getElementById('stat-fav-game').innerText = "Dragon's Treasure"; 
                document.getElementById('stat-last-game').innerText = "Dragon's Treasure";
                
                // é¡¯ç¤ºç¸½å±€æ•¸
                document.getElementById('stat-total-spins').innerText = (currentUser.totalSpins || 0).toLocaleString();
            }
            // â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜…

            // 2. è™•ç† VIP é ­åƒèˆ‡é¡è‰²
            const avatarImg = document.querySelector('.avatar-img');
            const vipText = document.querySelector('.vip-text');
            const profileAvatar = document.querySelector('.p-avatar');

            if (currentUser.isGuest) {
                avatarImg.src = 'guest.png';
                avatarImg.style.borderColor = '#999'; 
                vipText.innerText = "GUEST";
                vipText.style.color = '#999'; 
                if(profileAvatar) {
                    profileAvatar.src = 'guest.png';
                    profileAvatar.style.borderColor = '#999';
                }
                // è¨ªå®¢éš±è—æˆ–æ­¸é›¶ç¶“é©—æ¢
                document.querySelector('.vip-fill').style.width = '0%';
            } else {
                avatarImg.src = 'player.png';
                avatarImg.style.borderColor = '#ffd700'; 
                vipText.innerText = "VIP." + currentUser.vip;
                vipText.style.color = '#f4d06f'; 
                if(profileAvatar) {
                    profileAvatar.src = 'player.png';
                    profileAvatar.style.borderColor = '#ffd700';
                }

                // â˜… [æ–°å¢] ç¶“é©—æ¢å‹•æ…‹è¨ˆç®—é‚è¼¯ â˜…
                // è¨­å®šï¼šä¸‹ä¸€ç´šæ‰€éœ€ç¶“é©— = ç•¶å‰ç­‰ç´š * 1000 (ä¾‹: VIP1éœ€1000exp, VIP2éœ€2000exp)
                let currentExp = currentUser.exp || 0;
                let currentVip = currentUser.vip || 1;
                let nextLevelExp = currentVip * 1000; 
                
                // è¨ˆç®—ç™¾åˆ†æ¯” (é™åˆ¶æœ€å¤§ 100%)
                let percent = (currentExp / nextLevelExp) * 100;
                if(percent > 100) percent = 100;

                // æ›´æ–° UIï¼šå¯¬åº¦ èˆ‡ æ–‡å­—
                document.querySelector('.vip-fill').style.width = percent + '%';
                
                // æ›´æ–°å·¦å³å…©é‚Šçš„ VIP æ–‡å­— (ä¾‹å¦‚: VIP.1 ----> VIP.2)
                const vipLabels = document.querySelectorAll('.vip-labels span');
                if(vipLabels.length >= 2) {
                    vipLabels[0].innerText = "VIP." + currentVip;
                    vipLabels[1].innerText = "VIP." + (currentVip + 1);
                }
            }

            // 3. è™•ç†ç™»å…¥/ç™»å‡ºæŒ‰éˆ•æ–‡å­—
            const authItem = document.getElementById('opt-auth-item');
            if (authItem) {
                if (currentUser.isGuest) {
                    authItem.innerHTML = '<span class="opt-icon">ğŸ”</span> ç™»å…¥å¸³è™Ÿ';
                } else {
                    authItem.innerHTML = '<span class="opt-icon">ğŸ‘‹</span> ç™»å‡ºå¸³è™Ÿ';
                }
            }
        }

        function updateUserBalance(amount) {
            if(currentUser.isGuest) return; 
            db.ref('players/' + myUserId + '/balance').transaction((currentBalance) => {
                return (currentBalance || 0) + amount;
            });
        }

        async function initDynamicGameList() {
            const mainContainer = document.querySelector('.main-scroll-area');
            const slotsContainer = document.querySelector('.slots-grid');
            mainContainer.innerHTML = '';
            slotsContainer.innerHTML = '';

            // â˜… æŠ½å‡ºå•Ÿå‹•éŠæˆ²çš„é‚è¼¯ï¼Œè®“ã€Œä¸»é å¡ç‰‡ã€å’Œã€ŒSlotsåˆ—è¡¨ã€éƒ½èƒ½å…±ç”¨
            const launchDragonGame = (e) => {
                e.stopPropagation(); // é˜»æ­¢å†’æ³¡
                
                // é—œé–‰æ‰€æœ‰é¢æ¿ (å¦‚æœåœ¨ Slots é¢æ¿å…§é»æ“Šï¼Œéœ€è¦å…ˆé—œé–‰é¢æ¿)
                document.querySelectorAll('.dashboard-panel').forEach(p => p.classList.remove('active'));
                document.querySelector('.main-scroll-area').classList.add('hidden'); // éš±è—ä¸»æ²å‹•å€
                
                // æ’­æ”¾éŸ³æ•ˆ
                LobbyAudio.playClick();
                LobbyAudio.fadeOut();

                // è¦–è¦ºç‰¹æ•ˆ (å¦‚æœæ˜¯å¾å¡ç‰‡é»æ“Šï¼Œå¡ç‰‡æœƒæœ‰é£›å…¥å‹•ç•«ï¼›å¾ Slots é»å‰‡ç›´æ¥è½‰å ´)
                const dragonCard = document.getElementById('game-dragon');
                if(dragonCard) dragonCard.classList.add('launching');
                
                const overlay = document.getElementById('transition-overlay');
                const gameContainer = document.getElementById('game-container');
                const dragonUrl = "https://zendwucloud.github.io/Dragon-Treasure/"; 

                setTimeout(() => {
                    overlay.classList.add('active'); 
                    setTimeout(() => {
                        let iframe = document.createElement('iframe');
                        iframe.id = "game-frame";
                        iframe.src = dragonUrl;
                        iframe.allow = "autoplay; fullscreen";
                        const oldFrame = document.getElementById('game-frame');
                        if(oldFrame) oldFrame.remove();
                        gameContainer.appendChild(iframe);
                        gameContainer.style.display = 'block';
                        
                        iframe.onload = () => { 
                            if(currentUser) {
                                iframe.contentWindow.postMessage({
                                    type: 'initBalance', 
                                    value: currentUser.balance
                                }, '*');

                                const bgmOn = document.getElementById('bgm-toggle').checked;
                                const sfxOn = document.getElementById('sfx-toggle').checked;
                                iframe.contentWindow.postMessage({
                                    type: 'updateSettings',
                                    music: bgmOn,
                                    sfx: sfxOn
                                }, '*');
                            }
                            setTimeout(() => { overlay.classList.remove('active'); }, 300); 
                        };
                        setTimeout(() => { if(overlay.classList.contains('active')) overlay.classList.remove('active'); }, 1500);
                    }, 500); 
                }, 400);
            };

            let gameIndex = 1;
            let keepChecking = true;

            while (keepChecking && gameIndex <= 99) {
                const numStr = gameIndex.toString().padStart(3, '0');
                const imgName = `game${numStr}.png`;
                
                try {
                    await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.onload = resolve;
                        img.onerror = reject;
                        img.src = imgName;
                    });

                    // 1. å»ºç«‹ä¸»é å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = 'game-card';
                    if (gameIndex === 1) {
                        card.id = 'game-dragon'; 
                        // â˜… ç¶å®šå•Ÿå‹•å‡½å¼
                        card.onclick = launchDragonGame;
                    }
                    card.innerHTML = `<img src="${imgName}" class="game-img" alt="Game ${gameIndex}">`;
                    mainContainer.appendChild(card);

                    // 2. å»ºç«‹ Slots é¢æ¿åœ–ç¤º
                    const slot = document.createElement('div');
                    slot.className = 'slot-icon';
                    if (gameIndex === 1) {
                        // â˜… é€™è£¡ä¹Ÿè¦ç¶å®šå•Ÿå‹•å‡½å¼ï¼
                        slot.onclick = launchDragonGame;
                        // åŠ å€‹æ‰‹å‹æ¸¸æ¨™æç¤º
                        slot.style.cursor = 'pointer';
                    }
                    slot.innerHTML = `<img src="${imgName}" class="slot-thumb">`;
                    slotsContainer.appendChild(slot);

                    gameIndex++;
                } catch (e) {
                    keepChecking = false;
                }
            }
            const spacer = document.createElement('div');
            spacer.style.height = '5vh';
            mainContainer.appendChild(spacer);
        }

        // â˜… æ–°åŠŸèƒ½ï¼šè™•ç†ä¸‹æ³¨ç¶“é©—å€¼ (æ¯ä¸‹æ³¨ 100 é‡‘å¹£ = 1 EXP)
        function processBetExp(betAmount) {
            if (!currentUser || currentUser.isGuest) return;

            // è¨­å®šè½‰æ›ç‡ï¼šä¾‹å¦‚ä¸‹æ³¨ 100 å…ƒç²å¾— 1 é»ç¶“é©—
            // å¦‚æœæ‚¨å¸Œæœ›ä¸‹æ³¨å¤šå°‘å°±å¾—å¤šå°‘ç¶“é©—ï¼Œæ”¹æˆ let gainedExp = betAmount;
            let gainedExp = Math.floor(betAmount / 100); 
            if (gainedExp < 1 && betAmount > 0) gainedExp = 0; // ä¿®æ­£é‚è¼¯

            let currentExp = (currentUser.exp || 0) + gainedExp;
            let currentVip = currentUser.vip || 1;
            let needExp = currentVip * 1000; 

            // â˜… æ–°å¢ï¼šç´¯è¨ˆéŠç©å±€æ•¸ (Total Spins)
            // æ¯æ¬¡æ”¶åˆ° bet è¨Šè™Ÿï¼Œä»£è¡¨ç©å®¶ç©äº†ä¸€å±€
            let totalSpins = (currentUser.totalSpins || 0) + 1;

            let isLevelUp = false;
            if (currentExp >= needExp) {
                currentVip++;
                currentExp = currentExp - needExp; 
                isLevelUp = true;
            }

            const updates = {
                exp: currentExp,
                vip: currentVip,
                totalSpins: totalSpins // â˜… å¯«å…¥è³‡æ–™åº«
            };

            // â˜…â˜…â˜… æ–°å¢ï¼šå¦‚æœæ˜¯å‡ç´šç‹€æ…‹ï¼Œé †ä¾¿ç´€éŒ„ç•¶ä¸‹æ™‚é–“ â˜…â˜…â˜…
            if (isLevelUp) {
                updates.lastLevelUpDate = Date.now();
            }
            // â˜…â˜…â˜… æ–°å¢çµæŸ â˜…â˜…â˜…

            db.ref('players/' + myUserId).update(updates).then(() => {
                if (isLevelUp) {
                    LobbyAudio.playMoney(); // æ’­æ”¾éŸ³æ•ˆ
                    // é¡¯ç¤ºå‡ç´šé€šçŸ¥
                    showGhostTicker(`ğŸ†™ æ­å–œå‡ç´šï¼æ‚¨ç¾åœ¨æ˜¯ VIP.${currentVip}ï¼`);
                    
                    // â˜… é †ä¾¿æ›´æ–°æœ¬åœ°ç·©å­˜
                    currentUser.lastLevelUpDate = updates.lastLevelUpDate;
                }
                // æ›´æ–° currentUser æœ¬åœ°è³‡æ–™ï¼Œç¢ºä¿ UI ç«‹å³åæ‡‰
                currentUser.exp = currentExp;
                currentUser.vip = currentVip;
                currentUser.totalSpins = totalSpins;
                updateUserUI(); 
            });
        }

        // â˜… ä¿®æ”¹å¯†ç¢¼åŠŸèƒ½
        window.changePassword = function() {
            if (!currentUser || currentUser.isGuest) {
                alert("è¨ªå®¢ç„¡æ³•ä¿®æ”¹å¯†ç¢¼ï¼Œè«‹å…ˆè¨»å†Šæ­£å¼å¸³è™Ÿã€‚");
                return;
            }
            
            // ç°¡å–®çš„å®‰å…¨é©—è­‰
            let oldPass = prompt("è«‹è¼¸å…¥èˆŠå¯†ç¢¼ä»¥é©—è­‰èº«åˆ†ï¼š");
            if (oldPass !== currentUser.password) {
                alert("âŒ èˆŠå¯†ç¢¼éŒ¯èª¤ï¼");
                return;
            }

            let newPass = prompt("è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼š");
            if (!newPass || newPass.length < 4) {
                alert("âŒ å¯†ç¢¼å¤ªçŸ­æˆ–ç„¡æ•ˆï¼");
                return;
            }

            db.ref('players/' + myUserId).update({
                password: newPass
            }).then(() => {
                LobbyAudio.playTake();
                alert("âœ… å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼ä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚");
            });
        }

        // --- â˜… Main DOM Ready â˜… ---
        document.addEventListener('DOMContentLoaded', () => {
            LobbyAudio.init();
            initUser(); 
            initDynamicGameList(); 

            // Bind Navigation
            const navItems = document.querySelectorAll('.nav-item');
            const mainScroll = document.querySelector('.main-scroll-area');
            const slotsPanel = document.getElementById('slots-panel');
            const rewardsPanel = document.getElementById('rewards-panel');
            const profilePanel = document.getElementById('profile-panel');
            const rankingsPanel = document.getElementById('rankings-panel'); 
            const closeButtons = document.querySelectorAll('.close-gold-btn');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    navItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    if (item.id === 'nav-slots') openPanel(slotsPanel);
                    else if (item.id === 'nav-rewards') openPanel(rewardsPanel); 
                    else if (item.id === 'nav-profile') openPanel(profilePanel);
                    else if (item.id === 'nav-rankings') openRankingsPanel();
                    else closeAllPanels();
                });
            });

            function openPanel(targetPanel) {
                mainScroll.classList.add('hidden');
                [slotsPanel, rewardsPanel, profilePanel, rankingsPanel].forEach(p => {
                    if(p !== targetPanel) p.classList.remove('active');
                });
                setTimeout(() => { targetPanel.classList.add('active'); }, 200);
                if(targetPanel === rewardsPanel) renderRewards();
            }

            function closeAllPanels() {
                [slotsPanel, rewardsPanel, profilePanel, rankingsPanel].forEach(p => p.classList.remove('active'));
                setTimeout(() => { mainScroll.classList.remove('hidden'); }, 200);
                navItems.forEach(i => i.classList.remove('active'));
                document.getElementById('nav-home').classList.add('active');
            }

            closeButtons.forEach(btn => btn.addEventListener('click', closeAllPanels));

            // Bind Option Button
            const optionBtn = document.querySelector('.menu-btn');
            const optionDropdown = document.getElementById('option-dropdown');
            if (optionBtn) {
                optionBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    optionDropdown.classList.toggle('active');
                });
            }
            document.addEventListener('click', (e) => {
                if (optionDropdown.classList.contains('active') && !optionDropdown.contains(e.target) && e.target !== optionBtn) {
                    optionDropdown.classList.remove('active');
                }
            });

            // Bind Wallet
            const walletModal = document.getElementById('wallet-modal');
            const closeWalletBtn = document.getElementById('close-wallet-btn');
            const plusBtn = document.querySelector('.plus-btn');

            if (plusBtn) plusBtn.addEventListener('click', () => {
                if(currentUser.isGuest) { alert("è¨ªå®¢ç„¡æ³•å„²å€¼"); return; }
                walletModal.classList.add('active');
            });
            if (closeWalletBtn) closeWalletBtn.addEventListener('click', () => walletModal.classList.remove('active'));

            function openRankingsPanel() {
                openPanel(rankingsPanel);
                const listDiv = document.getElementById('rank-list-content');
                listDiv.innerHTML = '<div style="text-align:center; color:#888;">è¼‰å…¥ä¸­...</div>';
                db.ref('players').orderByChild('balance').limitToLast(10).once('value', (snapshot) => {
                    listDiv.innerHTML = '';
                    const players = [];
                    snapshot.forEach(child => { players.push(child.val()); });
                    players.reverse();
                    players.forEach((p, index) => {
                        const item = document.createElement('div');
                        item.className = 'rank-item';
                        item.innerHTML = `<div class="rank-num">${index + 1}</div><img src="player.png" class="rank-avatar"><div class="rank-info"><div class="rank-name">${p.name}</div><div class="rank-vip">VIP.${p.vip || 0}</div></div><div class="rank-val">${(p.balance || 0).toLocaleString()}</div>`;
                        listDiv.appendChild(item);
                    });
                });
            }

            // â˜… æ–°å¢ï¼šéŸ³æ•ˆè¨­å®šé€£å‹•é‚è¼¯
            const bgmToggle = document.getElementById('bgm-toggle');
            const sfxToggle = document.getElementById('sfx-toggle');

            // 1. å®šç¾©å‚³é€è¨­å®šçµ¦éŠæˆ²çš„å‡½å¼
            function syncSettingsToGame() {
                const isBgmOn = bgmToggle.checked;
                const isSfxOn = sfxToggle.checked;
                
                // å„²å­˜è¨­å®šåˆ°ç€è¦½å™¨
                localStorage.setItem('casino_bgm_on', isBgmOn);
                localStorage.setItem('casino_sfx_on', isSfxOn);

                // å¦‚æœéŠæˆ²è¦–çª—å­˜åœ¨ï¼Œå°±ç™¼é€è¨Šè™Ÿ
                const gameFrame = document.getElementById('game-frame');
                if (gameFrame && gameFrame.contentWindow) {
                    gameFrame.contentWindow.postMessage({
                        type: 'updateSettings',
                        music: isBgmOn,
                        sfx: isSfxOn
                    }, '*');
                }
            }

            // 2. è®€å–èˆŠè¨­å®š
            if (localStorage.getItem('casino_sfx_on') === 'false') {
                sfxToggle.checked = false;
            }

            // 3. ç¶å®šé–‹é—œäº‹ä»¶
            bgmToggle.addEventListener('change', () => {
                LobbyAudio.toggleMute(!bgmToggle.checked); 
                syncSettingsToGame(); // åŒæ­¥çµ¦éŠæˆ²
            });
            
            sfxToggle.addEventListener('change', () => {
                // å¤§å»³ç›®å‰æ²’æœ‰å¤ªå¤šéŸ³æ•ˆï¼Œä¸»è¦æ§åˆ¶æŒ‰éˆ•è²
                if(sfxToggle.checked) LobbyAudio.sfxClick.volume = 1.0;
                else LobbyAudio.sfxClick.volume = 0;
                syncSettingsToGame(); // åŒæ­¥çµ¦éŠæˆ²
            });
        });

        // é–å®šç¸®æ”¾
        document.querySelectorAll('img').forEach(img => img.addEventListener('dragstart', e => e.preventDefault()));
        document.addEventListener('gesturestart', e => e.preventDefault());
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) event.preventDefault();
            lastTouchEnd = now;
        }, false);

        document.addEventListener('pointerdown', (e) => {
            if (e.target.closest('.clickable-btn, .nav-item, .w-btn, .close-gold-btn, .game-card, .r-tab-btn, .w-option, .opt-item, .mail-item, .send-btn, .compose-btn, .mail-delete-btn')) {
                LobbyAudio.playClick();
            }
        });

        // â˜… Home éµç›£è½ (å…¨åŸŸ)
        window.addEventListener('message', (event) => {
            if (typeof event.data === 'string' && event.data === 'closeGame') {
                const overlay = document.getElementById('transition-overlay');
                const gameContainer = document.getElementById('game-container');
                const dragonCard = document.getElementById('game-dragon');
                overlay.classList.add('active'); 
                
                if(currentUser && currentUser.isGuest) {
                    db.ref('players/' + myUserId).remove().then(() => {
                        sessionStorage.removeItem('casino_guest_id');
                        setTimeout(() => location.reload(), 500);
                    });
                    return;
                }

                setTimeout(() => {
                    gameContainer.style.display = 'none';
                    const iframe = document.getElementById('game-frame');
                    if(iframe) iframe.remove(); 
                    if(dragonCard) dragonCard.classList.remove('launching');
                    overlay.classList.remove('active'); 
                    LobbyAudio.playBGM(); 
                    if(myUserId) {
                        db.ref('players/' + myUserId).once('value', (snapshot) => {
                            const data = snapshot.val();
                            if(data) { currentUser = data; updateUserUI(); }
                        });
                    }
                }, 500);
            }
            // è™•ç†é¤˜é¡æ›´æ–°
            if (typeof event.data === 'object' && event.data !== null && event.data.type === 'updateBalance') {
                if(!currentUser.isGuest) db.ref('players/' + myUserId).update({ balance: event.data.value });
                else db.ref('players/' + myUserId).update({ balance: event.data.value });
                
                if(currentUser) { 
                    currentUser.balance = event.data.value; 
                    updateUserUI(); 
                }
            }

            // â˜… æ–°å¢ï¼šç›£è½ã€Œä¸‹æ³¨ã€äº‹ä»¶ä¾†å¢åŠ ç¶“é©—å€¼
            if (typeof event.data === 'object' && event.data !== null && event.data.type === 'bet') {
                const betAmount = event.data.amount; 
                processBetExp(betAmount); 
            }
        });

        (function initLobbyBackground() {
            const canvas = document.getElementById('lobby-bg-canvas');
            const container = document.querySelector('.app-container'); 
            if (!canvas || !container) return;
            const ctx = canvas.getContext('2d');
            let width, height, particles = [];
            const particleCount = 200;

            function resize() {
                width = container.clientWidth;
                height = container.clientHeight;
                canvas.width = width;
                canvas.height = height;
            }

            class Particle {
                constructor() { this.reset(true); }
                reset(isInit = false) {
                    let randX = (Math.random() + Math.random()) / 2;
                    this.x = randX * width;
                    this.y = isInit ? Math.random() * height : height + Math.random() * 50;
                    let speedFactor = 1 - Math.abs(randX - 0.5) * 5; 
                    this.vy = -(Math.random() * 1.2 + 0.5 + speedFactor * 0.8); 
                    this.vx = (Math.random() - 0.5) * 0.2; 
                    this.size = Math.random() * 2.5 + 0.5;
                    this.maxAlpha = Math.random() * 0.5 + 0.3; 
                    this.alpha = this.maxAlpha;
                    this.color = `244, 208, 111`; 
                }
                update() {
                    this.x += this.vx; this.y += this.vy; 
                    let fadeStartPoint = height * 0.5;
                    if (this.y < fadeStartPoint) {
                        this.alpha = (this.y / fadeStartPoint) * this.maxAlpha;
                        if (this.alpha < 0) this.alpha = 0;
                    } else { this.alpha = this.maxAlpha; }
                    if (this.y < -10) this.reset(false);
                }
                draw() {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(${this.color}, ${this.alpha})`;
                    if (this.alpha > 0.01) { ctx.shadowBlur = 10; ctx.shadowColor = `rgba(${this.color}, 0.8)`; }
                    ctx.fill(); ctx.shadowBlur = 0; 
                }
            }
            function initParticles() { particles = []; for (let i = 0; i < particleCount; i++) particles.push(new Particle()); }
            function drawPillar() {
                ctx.globalCompositeOperation = 'screen'; 
                let gradient = ctx.createRadialGradient(width/2, height/2, 1, width/2, height/2, width * 0.75);
                gradient.addColorStop(0, "rgba(244, 208, 111, 0.25)"); 
                gradient.addColorStop(0.5, "rgba(20, 20, 20, 0.1)");
                gradient.addColorStop(1, "rgba(0, 0, 0, 0)");
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, width, height);
                let pillarWidth = width * 0.25;
                let linearGrad = ctx.createLinearGradient(width/2 - pillarWidth/2, 0, width/2 + pillarWidth/2, 0);
                linearGrad.addColorStop(0, "rgba(0,0,0,0)");
                linearGrad.addColorStop(0.5, "rgba(244, 208, 111, 0.12)");
                linearGrad.addColorStop(1, "rgba(0,0,0,0)");
                ctx.fillStyle = linearGrad; ctx.fillRect(width/2 - pillarWidth/2, 0, pillarWidth, height);
                ctx.globalCompositeOperation = 'source-over'; 
            }
            function animate() {
                ctx.clearRect(0, 0, width, height);
                drawPillar();
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            }
            window.addEventListener('resize', resize);
            resize(); initParticles(); animate();
        })();
    </script>
</body>
</html>